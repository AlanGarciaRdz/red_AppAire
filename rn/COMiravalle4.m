function [Y,Xf,Af] = COMiravalle4(X,~,~)
%COMIRAVALLE4 neural network simulation function.
%
% Generated by Neural Network Toolbox function genFunction, 20-May-2016 13:56:43.
% 
% [Y] = COMiravalle4(X,~,~) takes these arguments:
% 
%   X = 1xTS cell, 1 inputs over TS timesteps
%   Each X{1,ts} = 8xQ matrix, input #1 at timestep ts.
% 
% and returns:
%   Y = 1xTS cell of 1 outputs over TS timesteps.
%   Each Y{1,ts} = 1xQ matrix, output #1 at timestep ts.
% 
% where Q is number of samples (or series) and TS is the number of timesteps.

%#ok<*RPMT0>

% ===== NEURAL NETWORK CONSTANTS =====

% Input 1
x1_step1_xoffset = [1;1;0;0;0;0;0;0];
x1_step1_gain = [0.0384615384615385;0.0869565217391304;0.304971027752364;15.3846153846154;0.0208986415882968;0.056980056980057;0.0063552589768033;0.141843971631206];
x1_step1_ymin = -1;

% Layer 1
b1 = [-2.0880102119361927;2.6592265013110361;0.88543238377756084;-0.23208336230848434;-0.44307924023456313;0.53114567614125641;0.56284285415063084;-0.68519230741819059;10.354767139750518;0.44933816332056636;2.4380895522816162];
IW1_1 = [1.9074947974527126 -0.69597670998081362 -0.27479064862499208 0.28901707865091447 -0.20863307759301769 -0.61596872185735418 0.26575765885668295 -0.33816352415788409;-0.03282488687706054 -4.3908253761895555 0.18442427601863881 0.10874218545127767 -0.86649703760228214 -1.2441680270039974 0.024734779821078114 -0.47999488849782312;-0.61049546976975311 0.56433593635614065 -0.29639203036782075 0.4684692536650375 -0.20974164207217666 1.7681236556703095 0.026566759607563172 0.085569965801644748;-0.4224053055053697 1.4609138377701159 0.1178744570504841 -0.0024946220110967504 -0.925539874841662 -1.3241542542380316 -0.40812844649778052 0.062013659076466887;0.097356898124160193 -2.306470997221008 0.60682232964478633 0.06031527713530431 0.47114004345348454 1.2800887171944859 -0.28237637145656591 0.087835330873327053;1.0972116171067585 1.0128433326503621 -0.098522126205463481 -0.052705238731729977 0.83666655323637751 1.4527283989538016 -0.092501739350585366 -0.056412442888889622;0.036372001442042404 2.5277212934550293 -0.20430412234107179 -0.096395298789700185 -0.029753986704010572 0.22365234890372548 -0.09347285340026841 -0.24556783629389176;-2.8620822233494647 1.9882700130765143 0.10050369106668808 0.14919352163147642 0.57783893561245281 0.89413168953760147 0.52159758726787209 0.17984870698028543;12.983208619810796 0.74973570228239284 -0.40795387557685342 0.55685206086028782 0.36239618411580971 -0.051997703290091998 0.035554228920418554 0.69807525466472164;1.480428323872468 -0.047657595184785601 0.6115410901423638 0.76057456267793933 -0.15775397785135378 -0.10786419327675568 0.17542525069264739 -0.17633184939446783;0.20200298283304993 1.0242085904896507 -3.0386696720302759 -0.48643358104885137 3.0065684015064704 -1.1623164698569892 3.317578163653911 2.8882919018890338];

% Layer 2
b2 = [4.8290479938051281;-0.90041826303107786;0.95390034248384792;-1.5580771308026973;-0.44325375697448671;1.6877130766448851;-1.2048941190163371;0.60823230985181553;-6.2953657758003025;0.75353918626985505;-1.8046592247435442];
LW2_1 = [-0.80143250638950836 -0.93963043503245192 -0.28409055550217999 -1.0836108244753335 5.7105956842977212 -2.3239892670811058 2.6370623681989693 0.54914298233132075 2.420772473434484 -1.5634879343690384 0.24110578131513125;1.6014212991633352 -0.81210468553015158 2.7264946824913308 -1.949847201021575 -4.625870019069926 -0.3081032534143775 -3.538721830724517 0.058408347794246765 -1.5569241348695297 0.091415414887026814 -0.24215798424952337;0.64459719183949871 1.5629079779546589 1.0900248636949426 0.69193225164453298 -0.73418178115741339 0.44314013165965682 0.87341253333354707 1.041927917213866 0.077445208280842837 1.428380551843929 0.11275636274453904;2.0995545485208194 -1.4163608828059673 -0.21679987517659893 -0.75560726725585159 0.83230571607444859 -0.1605666256504088 -4.057703891555092 -0.74665817312099469 -0.16756275795241435 -2.1409551962119391 -0.57224223052838608;0.35451514111242177 -0.79528111067008611 0.24444840433447199 0.38277590785092852 1.3610932321474056 -1.2800760317797379 1.3741182393538613 0.020700147721021949 1.5732429682277018 0.69431661825802959 -0.16946324841907384;-0.2977699907558734 0.045634478433212666 0.76067679492459483 1.4872534028265099 -0.25361258534939796 0.66649203320730332 1.03668849398232 1.2804397764064603 0.54570273381246659 1.0792553223328016 0.26637047242672318;-2.6234732450229123 -0.036584448418822427 1.4272707498189381 2.1102726247107655 -0.048152146008514543 -0.9009479858025603 -2.1385194581952662 -0.20746805498200946 0.14796350168843977 2.1751086175602237 0.39297241406791972;0.068165336564102091 0.71541104422568835 -0.075234985970956722 -0.082573553504067157 -0.82860467170702978 0.97345747965811558 -0.94286097380989686 -0.025986896889925008 -1.3576513883193373 -0.51884224604536655 0.17166360631808383;-0.31629502874528354 0.4259119743699793 1.9818804681825883 -1.4073131071886644 2.2990871763937135 2.3487924571095786 0.012638037960522645 2.5394930326577421 0.17107477967484347 -2.9492416975325537 -0.79588626279567454;2.0681528548292856 0.26824835791646412 -0.73388616035903331 -1.0683195890770796 -0.25548432957675971 0.49478528618739109 1.0226837562596658 -0.39643928519383104 -0.21902722566673372 -0.97592502613842913 -0.21834015602991891;-0.7891871381838983 1.0058796192053236 0.098366935162777655 -0.0025000436327916225 -0.0023286290870595458 2.1794045544115237 -1.2633848164036812 1.0471754493231744 -2.0026136921449162 -1.1920338732339648 0.086294720896387914];

% Layer 3
b3 = -0.31249427191985996;
LW3_2 = [-0.62320657301709015 -0.16877269668969172 0.59454496669546286 -0.43691752106178272 -1.7777051964745776 -0.97634200830358053 0.23093622064205188 -2.2043015059246427 -0.31416549543096184 0.34070873435403221 0.49121873656618337];

% Output 1
y1_step1_ymin = -1;
y1_step1_gain = 0.448430493273543;
y1_step1_xoffset = 0;

% ===== SIMULATION ========

% Format Input Arguments
isCellX = iscell(X);
if ~isCellX, X = {X}; end;

% Dimensions
TS = size(X,2); % timesteps
if ~isempty(X)
    Q = size(X{1},2); % samples/series
else
    Q = 0;
end

% Allocate Outputs
Y = cell(1,TS);

% Time loop
for ts=1:TS

    % Input 1
    Xp1 = mapminmax_apply(X{1,ts},x1_step1_gain,x1_step1_xoffset,x1_step1_ymin);
    
    % Layer 1
    a1 = tansig_apply(repmat(b1,1,Q) + IW1_1*Xp1);
    
    % Layer 2
    a2 = tansig_apply(repmat(b2,1,Q) + LW2_1*a1);
    
    % Layer 3
    a3 = repmat(b3,1,Q) + LW3_2*a2;
    
    % Output 1
    Y{1,ts} = mapminmax_reverse(a3,y1_step1_gain,y1_step1_xoffset,y1_step1_ymin);
end

% Final Delay States
Xf = cell(1,0);
Af = cell(3,0);

% Format Output Arguments
if ~isCellX, Y = cell2mat(Y); end
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings_gain,settings_xoffset,settings_ymin)
y = bsxfun(@minus,x,settings_xoffset);
y = bsxfun(@times,y,settings_gain);
y = bsxfun(@plus,y,settings_ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n)
a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings_gain,settings_xoffset,settings_ymin)
x = bsxfun(@minus,y,settings_ymin);
x = bsxfun(@rdivide,x,settings_gain);
x = bsxfun(@plus,x,settings_xoffset);
end
