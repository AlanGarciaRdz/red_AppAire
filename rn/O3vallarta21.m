function [Y,Xf,Af] = O3vallarta21(X,~,~)
%O3VALLARTA21 neural network simulation function.
%
% Generated by Neural Network Toolbox function genFunction, 18-May-2016 13:05:55.
% 
% [Y] = O3vallarta21(X,~,~) takes these arguments:
% 
%   X = 1xTS cell, 1 inputs over TS timsteps
%   Each X{1,ts} = 7xQ matrix, input #1 at timestep ts.
% 
% and returns:
%   Y = 1xTS cell of 1 outputs over TS timesteps.
%   Each Y{1,ts} = 1xQ matrix, output #1 at timestep ts.
% 
% where Q is number of samples (or series) and TS is the number of timesteps.

%#ok<*RPMT0>

  % ===== NEURAL NETWORK CONSTANTS =====
  
  % Input 1
  x1_step1_xoffset = [1;1;0;0;0;0;0];
  x1_step1_gain = [0.0869565217391304;0.0384615384615385;5.12820512820513;24.390243902439;0.02710027100271;0.141843971631206;10.4712041884817];
  x1_step1_ymin = -1;
  
  % Layer 1
  b1 = [-1.3776117402300649;-2.6605366375073118;0.40038279151837597;-0.17449600216222824;0.40930839631405386;-0.42638719665505531;-1.2700892727728155;0.98610319486636144;-0.8971734461573132;1.9836845316043332;0.23017005132888696;4.566649118637824;-1.763976750144145;-1.4491447618667699];
  IW1_1 = [0.93772890009397425 0.34549678960404373 -0.5002365402426554 0.070322973096953706 -0.34526697280467844 -0.36451051944583579 -0.67204136022698746;0.45316145893453125 -0.97633477084504394 0.021217861641648815 -2.2743210326248211 -1.5718037219826271 -0.86927569488337642 2.63309508783207;1.3251849669893323 -1.0352524839695691 0.10403390559932328 -2.3537189646244419 1.4410838601797995 0.17080007286197529 1.2702653327189737;2.1084518555485716 0.61050594283112458 -0.69628478779399394 -0.50134498126152705 0.54314192529779892 0.19304566476359855 0.77378452638506889;-1.3170461988933901 0.29393207926199599 -0.5373083107875154 -0.52004794970085633 -0.87247826509806459 -1.0773747392222883 1.0141963128502389;-1.1930285346857299 0.01733869144178455 -2.2322506547908261 0.12284290544454571 0.08599813638347277 0.13927318271752778 0.73289786256858591;-0.52392678346023536 0.98589566832009068 -1.4545766080356501 -1.1226219111999307 -1.2128584147693675 0.24203678707459739 1.8807268507824755;0.64943959780319027 -1.5258572475870595 0.15643145111053847 -0.15172101941361935 0.98199564049887478 0.12075949366156322 1.6066610269154113;1.6540724671977056 1.4865350397343742 0.65346119776549505 0.67732370030650213 0.26155592384563553 -0.211833970999388 0.13205349383890691;1.3505058586243952 -1.8133967624011667 0.57545988581270968 -1.2181840926279517 1.212739048202321 0.11215042662242275 3.1234445689132317;-0.063419722163341102 1.4492186239601714 0.12054818451654747 2.0259911080058748 1.3240987551336609 -0.495469338589209 -1.5280614024473196;0.25949766851454603 0.4385079330805266 -0.30012317253161197 -0.48497201948581919 -0.64839859118237275 0.45795228440464247 4.4294238937524719;-1.6308655193831862 -0.42408927938449453 0.79817142972032784 0.83010167228038789 1.1910480372792871 -0.51080909022378995 -1.5008932171143516;0.63121800388047611 0.74422420659865374 0.44560267564290501 0.19125729440071165 0.66186424187909476 -0.86470203688689107 0.23595473838622083];
  
  % Layer 2
  b2 = [-1.2440332561839584;-1.4030438067648845;1.9528702936730853;-0.23918530328265666;-0.50699716325323063;0.58325150701611983;-1.101640125381687;-1.1645710339101905;0.14777421580122191;0.013740557023897287;-0.28734346285057205;-0.74816502348812175;-1.5742261993576818;-1.2714624827571568];
  LW2_1 = [0.66082883068504172 1.6263914839517926 0.67154537529319736 1.1251201670324533 0.65163218442097615 -0.23808915240155301 -0.12296789269373731 -0.69224729358364467 -0.14905949233440016 -0.3188695409717564 0.025470060084686288 -1.7595562494585852 0.24329591344019852 -1.0898810469763454;0.94948883772680093 -1.8960488604993058 0.030782929359636235 -0.2991815202696973 -0.21432664485664793 -0.80494142621784892 2.110357021882753 1.3540456028910295 0.82909626853197693 -0.61972973786595564 -1.850542320255677 0.11069866537706634 1.0474089159581972 -0.14806645113514391;-1.3623334377525778 -0.20923720075444521 -1.2512882897895548 -0.084782790052309723 -0.52632000509593102 -0.361207047411927 1.1057690749497138 -1.1881112617407483 0.37495003626423457 1.2449329463097754 -0.5126579764225313 -0.4657395955852891 -1.187582482751627 -1.1325671771732286;2.4254217345411044 0.16222641677997079 0.20667323330553564 -0.32341800581969005 0.20106258114339043 -0.088230285043437898 0.43216105923656162 2.3550765777052218 1.1179803896950289 0.11714200734274743 0.70092772787236579 -1.487330853439667 -1.149988663435761 0.10582950106862606;-0.55354622688797128 -0.31972454895538971 0.4197515957513005 0.74504255792406215 0.49695197602383484 0.046163625269367049 -0.33079120045577098 2.3130986401470768 1.5273522895456266 -1.2925228459905882 -0.46242009234361536 -2.1093138435209946 -0.57047277068359803 0.20818900113336841;-1.8644725700527351 -0.49898359432696421 -2.4791933550921548 -1.5883471873890469 1.5491941134036515 0.78242746892929838 -0.047737442500427371 0.82367919922125599 1.5052391873263662 -0.33583125753074755 0.37580990425359567 1.0372431303300758 -0.46384861435475089 -0.011865390240037823;-0.16357991966776625 0.60011814798838214 0.12145784417836664 -0.17935702754834554 0.32500666950355839 0.10133679756404106 -0.86761076137781046 -1.6392569869219207 -0.80753038793718457 1.078796855161281 0.84153067329882258 1.5491507378434721 0.4065607612468165 -0.029488012846801775;-0.4926740080431663 -0.18545199676261342 -0.83842253726083693 1.5239491571852579 -0.41340151492263927 0.55694976973488242 -1.2425962698403181 1.3521981942437491 -1.7254538686159022 -1.1216715945214346 -1.4251063069474144 -2.228991893453645 -0.36546385567646822 -0.5135158591027883;-0.16425371587494464 -1.2953207097314556 -0.97241923312639378 -0.50701371380679827 0.56069267843684889 0.18966838584613543 -0.58082072627059245 0.094156442428974613 -0.050171029373370764 0.7404524273484292 1.1683818629058982 1.6093327340383352 -0.53353200073800078 0.37348058059235534;0.71709329306276914 -0.70251718039358113 -0.28031650211658693 0.28675374516608171 -1.3496053589606547 -0.25956759533656687 1.6024516486023233 2.5072666551215752 1.6377422079988895 -0.92011194990796208 -0.20581151662756181 1.8143920760148042 0.98973476578099495 -1.2283333178993732;1.9129044484239877 0.096525791013452794 0.54822057989401696 -0.24023599647742919 0.33041571567120748 -0.68282210012806044 0.64064015245299522 2.5521721397313071 -0.070973348863986235 0.29782384272059031 2.1654223520807312 -0.68066549627216122 -0.27385458903477983 0.039501700508348267;0.49461355860695705 0.28789928282861443 -0.84290660162787134 0.04638118540482393 -0.15571877288107522 0.75158980482479887 0.23963374169265533 0.75252885066752229 0.92930699806160089 0.25722542257770958 -0.78486144044123951 -0.47869105743843937 0.1884744971854086 -0.3411358526763788;0.10227009663455312 0.058691674291854116 -1.1931894004371579 0.18315538575799384 0.3173429949997405 0.4169434683106536 -0.24777971508082244 1.7533810722697702 -1.5158380060159093 -0.48260194537231949 0.0050127460113017375 0.64551498205391256 0.32149544776344641 1.4155114895977512;0.23093113706409457 -0.61815751927955875 0.81665723971962523 -1.5866644241051246 -0.92486666397837625 0.11319184011197356 1.44516996203973 -0.57176018879403656 0.49532113723878357 -0.77236512519585709 -0.35444399619458716 0.12384553970257045 1.0674054749607174 -1.2754855694416647];
  
  % Layer 3
  b3 = 0.52332682147735821;
  LW3_2 = [0.75438959167176523 0.51614408617834717 2.5291630131501148 -1.3890510515265284 3.2302654084408511 -0.0622376310503596 1.0887965782483222 0.18810367795323962 0.99686905666311842 0.31817551533357386 1.3454340269499019 2.6132773283325617 -1.887015605368628 0.2993261601069519];
  
  % Output 1
  y1_step1_ymin = -1;
  y1_step1_gain = 10.4712041884817;
  y1_step1_xoffset = 0;
  
  % ===== SIMULATION ========
  
  % Format Input Arguments
  isCellX = iscell(X);
  if ~isCellX, X = {X}; end;
  
  % Dimensions
  TS = size(X,2); % timesteps
  if ~isempty(X)
    Q = size(X{1},2); % samples/series
  else
    Q = 0;
  end
  
  % Allocate Outputs
  Y = cell(1,TS);
  
  % Time loop
  for ts=1:TS
  
    % Input 1
    Xp1 = mapminmax_apply(X{1,ts},x1_step1_gain,x1_step1_xoffset,x1_step1_ymin);
    
    % Layer 1
    a1 = tansig_apply(repmat(b1,1,Q) + IW1_1*Xp1);
    
    % Layer 2
    a2 = tansig_apply(repmat(b2,1,Q) + LW2_1*a1);
    
    % Layer 3
    a3 = repmat(b3,1,Q) + LW3_2*a2;
    
    % Output 1
    Y{1,ts} = mapminmax_reverse(a3,y1_step1_gain,y1_step1_xoffset,y1_step1_ymin);
  end
  
  % Final Delay States
  Xf = cell(1,0);
  Af = cell(3,0);
  
  % Format Output Arguments
  if ~isCellX, Y = cell2mat(Y); end
end

% ===== MODULE FUNCTIONS ========

% Map Minimum and Maximum Input Processing Function
function y = mapminmax_apply(x,settings_gain,settings_xoffset,settings_ymin)
  y = bsxfun(@minus,x,settings_xoffset);
  y = bsxfun(@times,y,settings_gain);
  y = bsxfun(@plus,y,settings_ymin);
end

% Sigmoid Symmetric Transfer Function
function a = tansig_apply(n)
  a = 2 ./ (1 + exp(-2*n)) - 1;
end

% Map Minimum and Maximum Output Reverse-Processing Function
function x = mapminmax_reverse(y,settings_gain,settings_xoffset,settings_ymin)
  x = bsxfun(@minus,y,settings_ymin);
  x = bsxfun(@rdivide,x,settings_gain);
  x = bsxfun(@plus,x,settings_xoffset);
end
